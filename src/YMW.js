async function initMW(e,t){places=await fetch(t).then((e=>e.json())).catch((e=>console.error(e))),startMW(e)}function startMW(e){var t=new Array;Object.entries(places).forEach((([e,o])=>{t.push(o.city)}));var o=new Array;Object.entries(removeDuplicates(t)).forEach((([e,t])=>{o.push(new ymaps.control.ListBoxItem({data:{content:t.content,center:t.center,zoom:9}}))}));var n='\n <div class="MapLayer" id="'+e+'_Map"></div>\n <div class="Places">\n <div class="PanelContent"></div>\n <div class="Close" title="Скрыть" onclick="ClosePanel(this)"></div>\n </div>\n ';document.getElementById(e).classList.add("MapWidget"),document.getElementById(e).innerHTML=n;var a=new ymaps.Map(e+"_Map",{center:[56.838011,60.597465],zoom:9,controls:[]},{searchControlProvider:"yandex#search",suppressMapOpenBlock:!0,autoFitToViewport:"always"}),s=ymaps.templateLayoutFactory.createClass("<div class='Buttons'><div class='Group'><div class='Button Close' onclick='hide_widget(this)' title='Закрыть карту'>Close</div></div><div class='Group'><div class='Button' id='my-location' title='Моё местоположение'>Detect My Location</div></div><div class='Group'><div class='Button' id='zoom-in' title='Приблизить'>Zoom +</div><div class='Button' id='zoom-out' title='Отдалить'>Zoom -</div></div><div class='Group'><div class='Button List' id='map-list' title='Открыть список филлиалов'>Show locations list</div></div>",{build:function(){s.superclass.build.call(this),this.mapListCallback=ymaps.util.bind(this.mapList,this),this.zoomInCallback=ymaps.util.bind(this.zoomIn,this),this.zoomOutCallback=ymaps.util.bind(this.zoomOut,this),this.myLocationCallback=ymaps.util.bind(this.myLocation,this),document.getElementById("map-list").addEventListener("click",this.mapListCallback),document.getElementById("zoom-in").addEventListener("click",this.zoomInCallback),document.getElementById("zoom-out").addEventListener("click",this.zoomOutCallback),document.getElementById("my-location").addEventListener("click",this.myLocationCallback)},clear:function(){document.getElementById("map-list").removeEventListener("click",this.mapListCallback),document.getElementById("zoom-in").removeEventListener("click",this.zoomInCallback),document.getElementById("zoom-out").removeEventListener("click",this.zoomOutCallback),document.getElementById("my-location").removeEventListener("click",this.myLocationCallback),s.superclass.clear.call(this)},zoomIn:function(){var e=this.getData().control.getMap();e.setZoom(e.getZoom()+1,{checkZoomRange:!0})},zoomOut:function(){var e=this.getData().control.getMap();e.setZoom(e.getZoom()-1,{checkZoomRange:!0})},mapList:function(){var e=this.getData().control.getMap(),t=document.querySelector(".MapWidget .Places"),o=t.querySelector(".PanelContent");o.innerHTML=null;var n,a=document.createElement("ul");(n=document.createElement("li")).innerHTML="Список заведений",a.append(n),o.append(a),e.geoObjects.get(0).each((function(t){var o=document.createElement("li");o.title=t.properties.get("hintContent"),o.innerHTML=t.properties.get("hintContent"),o.addEventListener("click",ItemClickFunction,!1),o.geoObject=t,o.map=e,a.append(o)})),(n=document.createElement("li")).innerHTML="Всего: "+(a.querySelectorAll("li").length-1),a.append(n),o.append(a),t.classList.add("Active"),o.scroll({top:0,behavior:"smooth"})},myLocation:function(){var e=this.getData().control.getMap();navigator.geolocation.getCurrentPosition((function(t){var o=t.coords,n=[o.latitude,o.longitude];e.setCenter(n),e.setZoom(11)}),(function(e){console.warn(`ERROR(${e.code}): ${e.message}`)}),{enableHighAccuracy:!0,timeout:5e3,maximumAge:0})}}),i=new ymaps.control.ZoomControl({options:{layout:s}}),c=ymaps.templateLayoutFactory.createClass("<div class='City'><button class='CityDropdownBtn' type='button'>{{data.title}}</button><ul class='dropdown-menu'></ul></div>",{build:function(){c.superclass.build.call(this),this.childContainerElement=document.querySelector("#"+e+" .dropdown-menu"),this.events.fire("childcontainerchange",{newChildContainerElement:this.childContainerElement,oldChildContainerElement:null})},getChildContainerElement:function(){return this.childContainerElement},clear:function(){this.events.fire("childcontainerchange",{newChildContainerElement:null,oldChildContainerElement:this.childContainerElement}),this.childContainerElement=null,c.superclass.clear.call(this)}}),l=ymaps.templateLayoutFactory.createClass("<li>{{data.content}}</li>"),r=new ymaps.control.ListBox({items:o,data:{title:"Выберите город"},options:{layout:c,itemLayout:l}});r.events.add("click",(function(e){var t=e.get("target");t!=r&&a.setCenter(t.data.get("center"),t.data.get("zoom"))})),a.controls.add(r,{float:"left"}),a.controls.add(i);var d=ymaps.geolocation;d.get({provider:"yandex",mapStateAutoApply:!1}).then((function(e){e.geoObjects.options.set("hasBalloon",!1),e.geoObjects.options.set("zIndex",20),e.geoObjects.options.set("iconLayout","default#image"),e.geoObjects.options.set("iconImageSize",[24,24]),e.geoObjects.get(0).properties.set({hintContent:"Ваша позиция с помощью IP адреса"}),a.geoObjects.add(e.geoObjects)})),d.get({provider:"browser",mapStateAutoApply:!1}).then((function(e){e.geoObjects.options.set("hasBalloon",!1),e.geoObjects.options.set("zIndex",20),e.geoObjects.options.set("iconLayout","default#image"),e.geoObjects.options.set("iconImageSize",[24,24]),e.geoObjects.get(0).properties.set({hintContent:"Ваша позиция с помощью браузера"}),a.geoObjects.add(e.geoObjects)}));var u=new ymaps.GeoObjectCollection(null,{hasBalloon:!1,iconColor:"#3b5998"});places.length>0&&(Object.entries(places).forEach((([e,t])=>u.add(new ymaps.Placemark(t.coord,{hintContent:t.address,balloonContent:GenerateBaloonFromObject(t)},{preset:"islands#blueCircleDotIcon"})))),a.geoObjects.add(u),u.events.add("click",(function(e){var t=e.get("target"),o=document.querySelector(".MapWidget .Places"),n=o.querySelector(".PanelContent");o.classList.add("Active"),n.innerHTML=t.properties.get("balloonContent"),a.panTo(e.get("coords"),n.scroll({top:0,behavior:"smooth"}),{useMapMargin:!0,flying:!0})})))}function formatPhoneNumber(e){let t=(""+e).replace(/\D/g,"").match(/^(8|7|\+7|)?(\d{3})(\d{3})(\d{2})(\d{2})$/);return t?[(t[1],"+7 "),"(",t[2],") ",t[3],"-",t[4],"-",t[5]].join(""):e}function GenerateBaloonFromObject(e){var t="";return t+="<div class='BaloonContent'>",t+="<h4>"+e.name+"</h4>",t+="<p>"+e.address+"</p>",""!=e.subway&&isset(e.subway)&&(t+="<p>Метро: "+e.subway+"</p>"),t+="<p>Описание:</p>",t+="<p class='Sub'>"+e.description+"</p>",t+="<p class='Links'>",""!=e.email&&isset(e.email)&&(t+="<a target='_blank' class='Btn' href='mailto:"+e.email+"'>Email: "+e.email+"</a>"),""!=e.url&&isset(e.url)&&(t+="<a target='_blank' class='Btn' href='"+e.url+"' title='"+e.url+"'>Открыть Сайт</a>"),t+="</p>",isset(e.phones)&&(t+="<p>Телефон:</p>",Object.entries(e.phones).forEach((([e,o])=>{var n=formatPhoneNumber(o);t+="<p class='Sub Tel' onclick='this.focus();this.select()'><a href='tel:"+o+"'>"+n+"</a></p>"}))),isset(e.time)&&(t+="<p>Время работы:</p>",Object.entries(e.time).forEach((([e,o])=>{t+="<p class='Sub'>"+o+"</p>"}))),t+="</div>"}function getUniqueListBy(e,t){return[...new Map(e.map((e=>[e[t],e]))).values()]}function removeDuplicates(e){return Array.from(new Set(e.map((e=>e.content)))).map((t=>e.find((e=>e.content===t))))}function isset(e){try{return null!=e&&""!==e}catch(e){return!1}}function ItemClickFunction(e){var t=e.currentTarget.geoObject,o=e.currentTarget.map,n=[parseFloat(t.geometry.getCoordinates()[0]),parseFloat(t.geometry.getCoordinates()[1])];o.panTo(n,{useMapMargin:!0,flying:!0});var a=document.querySelector(".MapWidget .Places"),s=a.querySelector(".PanelContent");a.classList.add("Active"),s.innerHTML=t.properties.get("balloonContent"),s.scroll({top:0,behavior:"smooth"})}function ClosePanel(e){e.closest(".Places").classList.remove("Active")}function hide_widget(e){e.closest(".MapWidget").classList.remove("Active"),document.body.classList.remove("ModalMap"),document.querySelectorAll(".overlay").forEach((e=>e.remove()))}function HideMap(e){document.querySelector("#"+e).setAttribute("style",""),document.querySelector("#"+e).classList.remove("Active"),document.querySelector("#"+e).classList.remove("Wide"),document.querySelector("#"+e).classList.remove("Full"),document.querySelector("#"+e).classList.remove("Center"),document.querySelector("#"+e).classList.remove("Fixed"),document.querySelector("#"+e+" .Places").classList.remove("Active"),document.body.classList.remove("ModalMap"),document.querySelector("#"+e).classList.remove("Modal")}function ShowMap(e,t=0,o={}){HideMap(e);var n="";switch(t){case 0:default:document.querySelector("#"+e).classList.add("Center");break;case 1:document.querySelector("#"+e).classList.add("Wide"),document.querySelector("#"+e).classList.add("Center");break;case 2:document.querySelector("#"+e).classList.add("Full"),document.body.classList.add("ModalMap");break;case 3:document.querySelector("#"+e).classList.add("Modal"),document.body.classList.add("ModalMap");var a=document.createElement("div");a.classList.add("overlay"),window.document.body.insertBefore(a,window.document.body.firstChild)}isset(o.W)&&(n+="width:"+o.W+";"),isset(o.H)&&(n+="height:"+o.H+";"),isset(o.Fixed)&&1==o.Fixed&&document.querySelector("#"+e).classList.add("Fixed"),isset(n)&&document.querySelector("#"+e).setAttribute("style",n),document.querySelector("#"+e).classList.add("Active")}places=[];